---
layout: post
title: "P2P项目 二 注册&登录"
date: 2017-1-2
description: "p2p登录 注册"
tag: p2p 项目 SpringBoot
---
### 注册

1.js前台对表单的验证(表单域的校验)

    <script type="text/javascript">
    	$(function(){
    	    //validate方法里面括号里是个json格式参数
    	    $("#registerForm").validate({
    	        rules:{
    					username:{
    					    required:true,
    							rangelength:[4,16]
    					},
    					password:{
    					    required:true,
                                rangelength:[4,16]
    					},
    					confirmPwd:{
                            required:true,
                                equalTo:"#password"
    					}
    		},
    		messages:{
                    username:{
                        required:"用户名不可为空",
                            rangelength:"用户名{0}-{1}位"
                    },
                    password:{
                        required:"密码不可为空",
                            rangelength:"密码{0}-{1}位"
                    },
                    confirmPwd:{
                        required:true,
                            equalTo:"密码不一致"
                    }
    			}}
    		);
    	});

2.颜色,样式修改



3.导入mybatis-generator的依赖

    <build>
      <plugins>
        <plugin>
          <groupId>org.mybatis.generator</groupId>
          <artifactId>mybatis-generator-maven-plugin</artifactId>
          <version>1.3.2</version>
          <configuration>
            <verbose>true</verbose>
            <overwrite>false</overwrite>
          </configuration>
          <dependencies>
            <dependency>
              <groupId>mysql</groupId>
              <artifactId>mysql-connector-java</artifactId>
              <version>5.1.21</version>
            </dependency>
          </dependencies>
        </plugin>
      </plugins>
    </build>
后台数据的注册存储

4.密码加密
MD5

### 登陆

UserContext.java

    /**
     * 用户登录信息获取类
     */
    public class UserContext {
        private static final String LOGININFO_IN_SESSION = "logininfo";

        /**
         * 通过RequestContextHolder拿到session
         * @return
         */
        private static HttpSession getSession(){
            HttpSession session = ((ServletRequestAttributes)RequestContextHolder.getRequestAttributes()).getRequest().getSession();
            return session;
        }

        /**
         * 设置登录对象到session中
         * @param loginInfo
         */
        public static void setLoginInfo(LoginInfo loginInfo){
            getSession().setAttribute(LOGININFO_IN_SESSION,loginInfo);
        }

        /**
         * 从session中获取登录对象
         * @return
         */
        public static LoginInfo getLoginInfo(){
            return (LoginInfo) getSession().getAttribute(LOGININFO_IN_SESSION);
        }
}

LoginInfoService.userLogin()

    @Override
        public LoginInfo userLogin(String username, String password) {
            /**
             * 验证用户名和密码
             */
            checkUsernameAndPassword(username, password);
            /**
             * 进行数据库查询
             */
            LoginInfo result = loginInfoMapper.userLogin(username,MD5.encode(password+username));

            if(result == null){
                throw new DisplayableException("用户名或密码错误");
            }
            /**
             * 将用户信息放入session
             */
            UserContext.setLoginInfo(result);

            return result;
          }

登陆拦截

1.自定义拦截注解(core中)

    @Target({ElementType.METHOD})
    @Retention(RetentionPolicy.RUNTIME)
    public @interface NeedLogin {
    }

2.自定义登录拦截器

    /**
     * 登陆检查
     */
    public class LoginInterceptor extends HandlerInterceptorAdapter{
        public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception {
            if(handler instanceof HandlerMethod){
                //拿方法
                HandlerMethod met = (HandlerMethod)handler;
                //拿方法上的注解
                NeedLogin needLogin = met.getMethodAnnotation(NeedLogin.class);
                //判断注解是否为null,如果不为空,需要登录,检查UserContext是否有登录对象
                if (needLogin == null)return true;
                //登录对象为空跳转到登录页面
                if(UserContext.getLoginInfo()==null){
                    response.sendRedirect("/login.html");
                    return false;
                }
            }
            return true;
        }
    }



3.拦截器配置

    /**
     * 对自定义的LoginInterceptor进行配置
     */
    @Component
    public class MvcConfigurer extends WebMvcConfigurerAdapter {
        public void addInterceptors(InterceptorRegistry registry) {
            /**
             * 默认addPathPatterns可以不写
             */
            registry.addInterceptor(new LoginInterceptor()).addPathPatterns("/**");
        }
    }

4.Controller层写跳转至个人主页方法

    @Controller
    public class PersonController {
        @RequestMapping("person")
        @NeedLogin
        public String person(){
            return "/personal";
        }
    }
